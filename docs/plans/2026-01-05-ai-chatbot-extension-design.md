# AI Customer Support Chatbot — Chrome Extension

**Дата:** 2026-01-05
**Статус:** Утверждён

---

## Обзор проекта

Chrome Extension для AI-чатбота службы поддержки. Пользователи устанавливают расширение, вводят свой OpenAI API ключ, "обучают" бота на контенте своего сайта, и получают виджет чата для тестирования AI-ответов.

### Монетизация

| | Free | Pro ($9.99/мес) |
|---|------|-----------------|
| Сообщений/месяц | 50 | Безлимит |
| Сайтов | 1 | 10 |
| Страниц при парсинге | 5 | 20 |
| История чата | Нет | Да |
| Кастомизация виджета | Нет | Да |

---

## Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    Chrome Extension                      │
├──────────────┬──────────────────┬───────────────────────┤
│    Popup     │  Service Worker  │    Content Script     │
│  (настройки) │   (фоновый)      │   (виджет на сайте)   │
├──────────────┴──────────────────┴───────────────────────┤
│                  chrome.storage.local                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────────┐  │
│  │API ключ│ │Подписка │ │Обученные│ │История чатов  │  │
│  │        │ │Pro/Free │ │ сайты   │ │(только Pro)   │  │
│  └─────────┘ └─────────┘ └─────────┘ └───────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### Структура файлов

```
chatbot-extension/
├── manifest.json
├── popup/
│   ├── popup.html
│   ├── popup.js
│   └── popup.css
├── content/
│   ├── content.js        # Виджет чата
│   ├── parser.js         # Парсинг страниц
│   └── widget.css
├── background/
│   └── service-worker.js # API вызовы, координация
├── utils/
│   ├── storage.js        # Работа с chrome.storage
│   └── openai.js         # OpenAI API
└── icons/
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

---

## Popup (настройки)

### UI

```
┌────────────────────────────────────┐
│  🤖 AI Customer Support            │
│  ─────────────────────────────────│
│                                    │
│  API ключ OpenAI:                  │
│  ┌──────────────────────┐          │
│  │ sk-xxxxx...          │ [👁️]     │
│  └──────────────────────┘          │
│  [    💾 Сохранить ключ    ]       │
│                                    │
│  ─────────────────────────────────│
│  📊 Статус: Free                   │
│  Сообщений: 12/50 в этом месяце    │
│  Сайтов: 1/1                       │
│                                    │
│  [  ⭐ Перейти на Pro $9.99  ]     │
│  ─────────────────────────────────│
│                                    │
│  Текущий сайт: example.com         │
│  [  📚 Обучить на этом сайте  ]    │
│                                    │
│  Статус: ✅ Обучено (5 страниц)    │
│  ─────────────────────────────────│
│  ⚙️ Настройки виджета (Pro)        │
│  └─ Цвет, позиция, название...     │
└────────────────────────────────────┘
```

### Логика

- При открытии — загружает данные из `chrome.storage.local`
- "Сохранить ключ" — валидация формата `sk-...`, сохранение
- "Обучить" — отправляет сообщение в content script для парсинга
- "Перейти на Pro" — открывает Stripe Checkout ссылку
- Настройки виджета — активны только в Pro

---

## Виджет чата (Content Script)

### UI

```
Свёрнутый:                    Развёрнутый:
                              ┌────────────────────────────┐
                              │ 🤖 Помощник сайта      ✕  │
                              │ ────────────────────────── │
                              │                            │
                              │   Привет! Чем могу         │
                              │   помочь?                  │
                              │                      🤖    │
                              │                            │
                              │ 👤  Какие у вас цены?      │
                              │                            │
                              │   Наши цены начинаются     │
                              │   от $99. Подробнее на     │
                              │   странице /pricing        │
                              │                      🤖    │
                              │                            │
                              │ ────────────────────────── │
   ┌─────┐                    │ ┌──────────────────────┐ ┌───┐ │
   │ 💬  │                    │ │ Напишите вопрос..    │ │ ➤ │ │
   └─────┘                    │ └──────────────────────┘ └───┘ │
                              │  Powered by AI Chatbot     │
                              └────────────────────────────┘
```

### Поведение

- Кнопка 💬 появляется в углу (позиция настраивается в Pro)
- Клик — разворачивает окно чата (350×500px)
- Анимация появления сообщений (typing indicator)
- Сообщения AI — слева, пользователя — справа
- Enter — отправить, Shift+Enter — новая строка
- Крестик ✕ — свернуть обратно в кнопку

### Кастомизация (Pro)

| Параметр | Free | Pro |
|----------|------|-----|
| Цвет | Синий по умолчанию | Любой |
| Позиция | Правый нижний | 4 угла на выбор |
| Название бота | "Помощник" | Своё |
| Аватар | Эмодзи 🤖 | Загрузка картинки |
| Приветствие | Стандартное | Своё |

---

## Service Worker (фоновая логика)

### Задачи

```
┌─────────────────────────────────────────────────────────┐
│                   Service Worker                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📨 Обработка сообщений:                                │
│  ├── popup → "сохрани ключ" → chrome.storage            │
│  ├── popup → "обучи сайт" → content script              │
│  ├── content → "отправь вопрос" → OpenAI API            │
│  └── content → "парсинг готов" → сохранить данные       │
│                                                         │
│  🔐 OpenAI API вызовы:                                  │
│  ├── Получить ключ из storage                           │
│  ├── Сформировать промпт с контекстом сайта             │
│  ├── Отправить запрос к GPT-4o-mini                     │
│  └── Вернуть ответ в content script                     │
│                                                         │
│  📊 Управление лимитами:                                │
│  ├── Счётчик сообщений (сброс 1-го числа месяца)        │
│  ├── Проверка лимита сайтов                             │
│  └── Блокировка при превышении (Free)                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Формат сообщений

```javascript
// Popup → Service Worker
{ action: "saveApiKey", key: "sk-..." }
{ action: "trainSite", url: "https://example.com" }

// Content Script → Service Worker
{ action: "sendMessage", message: "Какие цены?", siteId: "example.com" }
{ action: "saveParsedContent", siteId: "example.com", pages: [...] }

// Service Worker → Content Script
{ action: "aiResponse", message: "Наши цены..." }
{ action: "startParsing", maxPages: 5 }
```

---

## Парсинг сайтов

### Алгоритм

```
1. Старт: пользователь нажал "Обучить"
   ↓
2. Парсим текущую страницу:
   • title, meta description
   • H1-H6 заголовки
   • Параграфы, списки, таблицы
   • Исключаем: nav, footer, script, style, ads
   ↓
3. Собираем внутренние ссылки:
   • Только тот же домен
   • Исключаем: #якоря, ?параметры, внешние
   • Приоритет: меню, навигация
   ↓
4. Парсим подстраницы (до лимита):
   • Free: 5 страниц
   • Pro: 20 страниц
   • Показываем прогресс: "3/5 страниц..."
   ↓
5. Сохраняем результат:
   • Объединяем текст всех страниц
   • Лимит: 50,000 символов на сайт
   • Сохраняем в chrome.storage.local
```

### Структура данных сайта

```javascript
{
  "site:example.com": {
    url: "https://example.com",
    title: "Example Company",
    parsedAt: "2026-01-05T12:00:00Z",
    pagesCount: 5,
    content: "Example Company\n\nО нас\nМы компания...\n\nЦены\nОт $99...",
    contentLength: 12500
  }
}
```

---

## Хранение данных

### Структура chrome.storage.local

```javascript
{
  // Настройки пользователя
  "settings": {
    apiKey: "sk-...",
    plan: "free",                    // "free" | "pro"
    stripeEmail: null,
    proActivatedAt: null
  },

  // Счётчики и лимиты
  "usage": {
    messagesThisMonth: 12,
    monthStart: "2026-01",
    sitesCount: 1
  },

  // Обученные сайты (ключ = домен)
  "site:example.com": { ... },

  // История чатов — только Pro
  "history:example.com": [
    { role: "assistant", text: "Привет!", time: "..." },
    { role: "user", text: "Какие цены?", time: "..." }
  ],

  // Кастомизация виджета — только Pro
  "widget": {
    color: "#4F46E5",
    position: "bottom-right",
    botName: "Помощник",
    avatar: null,
    greeting: "Привет! Чем могу помочь?"
  }
}
```

---

## Монетизация (Stripe)

### Схема работы

```
1. Пользователь нажимает "Перейти на Pro $9.99"
   ↓
2. Открывается Stripe Checkout (Payment Link)
   ↓
3. После оплаты — страница успеха с инструкцией:
   "Вернитесь в расширение и введите email"
   ↓
4. В Popup пользователь вводит email оплаты
   ↓
5. Сохраняем email, активируем Pro
```

### Данные подписки

```javascript
{
  plan: "pro",
  stripeEmail: "user@email.com",
  proActivatedAt: "2026-01-05T12:00:00Z"
}
```

### Настройка Stripe

1. Создать аккаунт Stripe
2. Products → Add product → "AI Chatbot Pro"
3. Цена: $9.99/месяц, recurring
4. Payment Links → создать ссылку
5. Вставить ссылку в код расширения

---

## Технические требования

- **Manifest:** V3 (новый стандарт Chrome)
- **Хранение:** chrome.storage.local
- **AI модель:** OpenAI GPT-4o-mini
- **Стили:** CSS (inline в виджете)
- **Бэкенд:** Не требуется (MVP)

---

## Следующие шаги

1. Создать manifest.json
2. Реализовать Popup (HTML/CSS/JS)
3. Реализовать Content Script (виджет + парсер)
4. Реализовать Service Worker (API + логика)
5. Тестирование в Chrome
6. Публикация в Chrome Web Store
